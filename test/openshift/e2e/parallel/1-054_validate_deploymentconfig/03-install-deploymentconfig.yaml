# It would be better to have the "kind: Application" resource as it is,
# but "${NAMESPACE}" expansion doesn't work in kuttl manifests
# We also need to centralize the app examples in a public (common) repo.
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
- script: |
    set -eo pipefail

    # Install ArgoCD Application with 2 replicas
    cat << EOF | oc apply -f -
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: app-deploymentconfig
      namespace: ${NAMESPACE}
    spec:
      project: default
      source:
        repoURL: https://github.com/bluengo/argocd-apps-examples
        path: ./deploymentconfig-example
        targetRevision: deploymentconfig_2-replicas
      destination:
        server: https://kubernetes.default.svc
        namespace: ${NAMESPACE}
      syncPolicy:
        automated: {}
    EOF
- script: |
    oc wait deploymentconfig --for=condition=Ready -n $NAMESPACE test-deploymentconfig --timeout=5m
    oc wait deploymentconfig -n $NAMESPACE test-deploymentconfig --for condition=Available=True --timeout=5m
